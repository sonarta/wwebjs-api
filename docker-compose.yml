# The version property is now optional in modern Docker Compose
version: '3.8'

name: wwebjs-api

services:
  api:
    # image: avoylenko/wwebjs-api:latest
    build: .
    container_name: wwebjs-api
    restart: always
    ports:
      - "3000:3000"
    env_file: .env
    environment:
      # Core Configuration
      - BASE_WEBHOOK_URL=http://localhost:3000/localCallbackExample
      - MAX_ATTACHMENT_SIZE=5000000 # In bytes (5MB)
      - SET_MESSAGES_AS_SEEN=TRUE
      - ENABLE_LOCAL_CALLBACK_EXAMPLE=TRUE
      - ENABLE_SWAGGER_ENDPOINT=TRUE
      - RECOVER_SESSIONS=TRUE
      
      # Security Settings
      # - API_KEY=your_global_api_key_here # Uncomment and set for production
      
      # Rate Limiting Configuration
      # - RATE_LIMIT_MAX=1000 # Maximum connections per time window
      # - RATE_LIMIT_WINDOW_MS=1000 # Time window in milliseconds
      
      # Browser Configuration
      - CHROME_BIN=/usr/bin/chromium
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
      
      # Session Configuration
      - SESSIONS_PATH=/home/pptruser/sessions
      
      # Enable debug logging
      - DEBUG=puppeteer:*
      
      # Callback Configuration
      - DISABLED_CALLBACKS=message_ack|message_reaction
    
    # Add necessary capabilities for Chrome to run in container
    cap_add:
      - SYS_ADMIN
    
    # Mount session directory for persistence with correct permissions
    volumes:
      - ./sessions:/home/pptruser/sessions
    
    # Run as non-root user with host user ID
    user: "1000:1000"
    
    # Ensure the container has enough shared memory for Chrome
    shm_size: 1gb
    
    # Run in privileged mode to avoid Chrome sandbox issues
    privileged: true
    # Optional healthcheck
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s
